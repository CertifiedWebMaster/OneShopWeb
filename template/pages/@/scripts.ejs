<%
const { resource, body, collection, slug } = await _.resolveRoute()
let echoContext = {}
if (body) {
  // store resource
  // remove large description strings if any
  echoContext = {
    resource,
    body: {
      ...body,
      body_html: '',
      body_text: ''
    }
  }
} else if (slug) {
  // cms folder collection
  // keep the slug only
  echoContext = {
    collection,
    slug,
    content: {}
  }
}

// also expose some store data
let echoData = {
  // up to 8 first level categories
  categories: _.categories.filter(({ parent }) => !parent).slice(0, 8),
  // up to 8 items with less and 'stable' data
  items: _.items.slice(0, 8).map(({ _id, sku, name, slug, pictures }) => {
    const item = { _id, sku, name, slug }
    if (Array.isArray(pictures)) {
      // output one picture per item only
      const picture = pictures.find(({ normal }) => normal)
      if (picture) {
        const { _id, normal } = picture
        item.pictures = [{ _id, normal }]
      }
    }
    return item
  })
}
%>

<script>
  window._settings = <%- JSON.stringify(_.settings) %>
  window._context = <%- JSON.stringify(echoContext) %>
  window._data = <%- JSON.stringify(echoData) %>
</script>
<script src="/storefront.js"></script>
